
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>100 Day Task Log</title>
  <style>
    :root { color-scheme: light dark; }
    :root[data-theme="light"] {
      --bg: #f7f8fb; --panel: #ffffff; --card: #ffffff; --text: #0b1020; --muted:#5b6578;
      --border:#e6e8ef; --accent:#4f7cff; --accent-2:#42c47a; --danger:#e5484d; --focus:#7aa2ff;
      --chip-bg:#eef2ff;
    }
    :root[data-theme="dark"] {
      --bg: #0f172a; --panel:#111827; --card:#0b1220; --text:#e6e9f2; --muted:#9aa3b2;
      --border:#1f2937; --accent:#86a8ff; --accent-2:#62d292; --danger:#ef4444; --focus:#9bb7ff;
      --chip-bg:#151d33;
    }
    html, body { height: 100%; }
    body {
      margin: 0; font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial;
      background: radial-gradient(1400px 700px at -10% -20%, color-mix(in oklab, var(--accent) 8%, var(--bg)) 0%, var(--bg) 30%, var(--bg) 100%);
      color: var(--text);
    }
    .container { max-width: 1100px; margin: 0 auto; padding: 18px; }
    header { position: sticky; top: 0; backdrop-filter: blur(10px); background: color-mix(in oklab, var(--bg) 80%, transparent); z-index: 10; border-bottom: 1px solid var(--border); }
    header .bar { display: flex; flex-wrap: wrap; gap: 10px; align-items: center; padding: 12px 18px; }
    h1 { font-size: 18px; margin: 0 8px 0 0; letter-spacing: .2px; }
    .spacer { flex: 1; }

    select, input[type="text"], input[type="time"], button { border-radius: 10px; font-size: 14px; }
    select, input[type="text"], input[type="time"] { padding: 8px 10px; border: 1px solid var(--border); background: var(--card); color: var(--text); outline: none; }
    select:focus, input:focus { border-color: var(--focus); box-shadow: 0 0 0 3px color-mix(in oklab, var(--focus) 30%, transparent); }
    button { padding: 8px 12px; border: 1px solid var(--border); background: color-mix(in oklab, var(--card) 80%, var(--accent)); color: var(--text); cursor: pointer; }
    button.primary { background: color-mix(in oklab, var(--accent) 20%, var(--card)); border-color: var(--accent); }
    button.danger { background: color-mix(in oklab, var(--danger) 15%, var(--card)); border-color: var(--danger); }

    .flex { display: flex; gap: 10px; align-items: center; }
    .panel { background: var(--panel); border: 1px solid var(--border); border-radius: 14px; padding: 14px; }

    .card { background: radial-gradient(1000px 500px at -20% -20%, color-mix(in oklab, var(--accent) 8%, var(--card)) 0%, var(--card) 40%, var(--card) 100%);
      border: 1px solid var(--border); border-radius: 16px; padding: 14px; }
    .date-row { display: flex; justify-content: space-between; align-items: center; }
    .date { font-weight: 700; }
    .muted { color: var(--muted); font-size: 12px; }
    .tasks { margin-top: 10px; display: flex; flex-direction: column; gap: 8px; }
    .task { display: grid; grid-template-columns: 1fr 130px 110px 34px; gap: 8px; align-items: center; }
    .total { font-weight: 600; font-variant-numeric: tabular-nums; padding: 4px 10px; border-radius: 999px; background: var(--chip-bg); border: 1px solid var(--border); }

    .chip { display: inline-flex; align-items: center; gap: 8px; padding: 2px 8px; border: 1px solid var(--border); border-radius: 999px; background: var(--chip-bg); font-size: 12px; }
    .dot { width: 10px; height: 10px; border-radius: 50%; display: inline-block; border: 1px solid var(--border); }

    #logWrap { margin-top: 16px; }
    table { width: 100%; border-collapse: collapse; }
    th, td { border-bottom: 1px solid var(--border); padding: 8px 10px; text-align: left; font-size: 14px; }
    th { font-weight: 600; }
    .table-head { background: color-mix(in oklab, var(--card) 80%, var(--panel)); }

    .modal { position: fixed; inset: 0; display: none; align-items: center; justify-content: center; background: rgba(0,0,0,.35); }
    .modal .box { background: var(--panel); border: 1px solid var(--border); border-radius: 14px; padding: 14px; width: min(520px, 92vw); }
    .row { display: grid; grid-template-columns: 1fr 120px 40px; gap: 8px; align-items: center; }
  </style>
</head>
<body>
  <header>
    <div class="bar">
      <h1>100 Day Task Log New</h1>
      <div class="flex">
        <label for="daySelect" class="muted">Day</label>
        <select id="daySelect"></select>
        <button id="addTask" class="primary">Add Task</button>
      </div>
      <div class="flex">
        <button id="openCats">Categories</button>
        <label class="muted" for="filterCat">Filter</label>
        <select id="filterCat"></select>
        <button id="toggleLog">Running Log</button>
      </div>
      <span class="spacer"></span>
      <button id="toggleMode">Theme</button>
    </div>
  </header>

  <main class="container">
    <section id="daySection" class="panel">
      <div id="dayCard" class="card"></div>
    </section>

    <section id="logWrap" class="panel" style="display:none">
      <div class="flex" style="justify-content: space-between;">
        <h2 style="margin:0;font-size:16px;">Running Log</h2>
        <div class="total" id="logTotal">0h 00m</div>
      </div>
      <div style="overflow:auto;">
        <table>
          <thead class="table-head">
            <tr><th>Date</th><th>Category</th><th>Task</th><th>Time</th></tr>
          </thead>
          <tbody id="logBody"></tbody>
        </table>
      </div>
    </section>
  </main>

  <div id="catModal" class="modal">
    <div class="box">
      <div class="flex" style="justify-content: space-between;">
        <h3 style="margin:0;font-size:16px;">Task Categories</h3>
        <button id="closeCats">Close</button>
      </div>
      <div id="catList" style="margin-top:10px; display:flex; flex-direction:column; gap:8px;"></div>
      <div class="row" style="margin-top:8px;">
        <input type="text" id="newCatName" placeholder="New category name" />
        <input type="color" id="newCatColor" value="#4f7cff" />
        <button id="addCat" class="primary">Add</button>
      </div>
    </div>
  </div>

  <template id="taskRowTpl">
    <div class="task">
      <input type="text" class="t-name" placeholder="Task" />
      <select class="t-cat"></select>
      <input type="time" class="t-time" step="60" />
      <button class="danger t-del">Ã—</button>
    </div>
  </template>

  <script>
    // ===== Backend config =====
    const API_BASE = localStorage.getItem('tasklog.api') || 'http://localhost:8787'; // change to your server URL
    const USE_SERVER = true; // set false to work only offline

    // ===== Keys and state =====
    const KEY = 'tasklog.v3';
    const CAT_KEY = 'tasklog.categories.v1';
    const THEME_KEY = 'tasklog.theme';
    let store = JSON.parse(localStorage.getItem(KEY) || '{}');
    let categories = JSON.parse(localStorage.getItem(CAT_KEY) || '[]');

    async function serverGet(path) {
      const r = await fetch(`${API_BASE}${path}`, { credentials: 'omit' });
      if (!r.ok) throw new Error('Server error');
      return r.json();
    }
    async function serverPut(path, body) {
      const r = await fetch(`${API_BASE}${path}`, { method: 'PUT', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(body) });
      if (!r.ok) throw new Error('Server error');
      return r.json();
    }

    // Seed categories on first run
    async function ensureDefaultCategories() {
      if (categories.length > 0) return;
      categories = [
        { id: 'work', name: 'Work', color: '#4f7cff' },
        { id: 'study', name: 'Study', color: '#42c47a' },
        { id: 'admin', name: 'Admin', color: '#f59e0b' },
        { id: 'break', name: 'Break', color: '#ef4444' }
      ];
      localStorage.setItem(CAT_KEY, JSON.stringify(categories));
      if (USE_SERVER) await serverPut('/api/categories', { categories });
    }

    const root = document.documentElement;
    function applyTheme(t){ root.setAttribute('data-theme', t); }
    function getPreferredTheme(){ const s=localStorage.getItem(THEME_KEY); if (s) return s; return window.matchMedia && window.matchMedia('(prefers-color-scheme: light)').matches ? 'light' : 'dark'; }
    let theme = getPreferredTheme(); applyTheme(theme);
    document.getElementById('toggleMode').addEventListener('click', ()=>{ theme = theme==='light' ? 'dark' : 'light'; localStorage.setItem(THEME_KEY, theme); applyTheme(theme); });

    function fmtDate(d){ const y=d.getFullYear(); const m=String(d.getMonth()+1).padStart(2,'0'); const day=String(d.getDate()).padStart(2,'0'); return `${y}-${m}-${day}`; }
    function humanDate(d){ return d.toLocaleDateString(undefined, { year: 'numeric', month: 'short', day: 'numeric' }); }
    function dayName(d){ return d.toLocaleDateString(undefined, { weekday: 'long' }); }

    const daySelect = document.getElementById('daySelect');
    const dayCard = document.getElementById('dayCard');
    const taskTpl = document.getElementById('taskRowTpl');

    const start = new Date(); start.setHours(0,0,0,0);
    const dates = Array.from({ length: 100 }, (_, i) => { const d=new Date(start); d.setDate(d.getDate()+i); return d; });

    for (const d of dates) {
      const opt = document.createElement('option');
      const ds = fmtDate(d);
      opt.value = ds; opt.textContent = `${dayName(d)}, ${humanDate(d)}`;
      daySelect.appendChild(opt);
    }
    const todayStr = fmtDate(new Date(start)); daySelect.value = todayStr;

    async function loadDay(ds) {
      if (!USE_SERVER) return store[ds] || [];
      try {
        const data = await serverGet(`/api/day/${ds}`);
        store[ds] = data.items || [];
        localStorage.setItem(KEY, JSON.stringify(store));
      } catch (e) {
        console.warn('Falling back to local day', e);
      }
      return store[ds] || [];
    }

    async function saveDay(ds){
      const rows = Array.from(dayCard.querySelectorAll('.task'));
      store[ds] = rows.map(r => ({
        name: r.querySelector('.t-name').value.trim(),
        cat: r.querySelector('.t-cat').value,
        time: r.querySelector('.t-time').value
      })).filter(t => t.name || t.time || t.cat);
      localStorage.setItem(KEY, JSON.stringify(store));
      if (USE_SERVER) {
        try { await serverPut(`/api/day/${ds}`, { items: store[ds] }); } catch(e){ console.warn('Save failed, kept offline', e); }
      }
      renderLog();
    }

    function parseTimeToMinutes(str){ if (!str) return 0; const [h,m] = str.split(':').map(Number); return (isFinite(h)&&isFinite(m)) ? h*60+m : 0; }
    function minutesToHm(mins){ const h=Math.floor(mins/60); const m=mins%60; return `${h}h ${String(m).padStart(2,'0')}m`; }

    async function renderDay(ds){
      dayCard.innerHTML = '';
      const dParts = ds.split('-'); const d = new Date(Number(dParts[0]), Number(dParts[1])-1, Number(dParts[2]));
      const head = document.createElement('div'); head.className = 'date-row';
      head.innerHTML = `<div><div class="date">${humanDate(d)}</div><div class="muted">${dayName(d)}</div></div><div class="total" id="dayTotal">0h 00m</div>`;
      dayCard.appendChild(head);

      const list = document.createElement('div'); list.className = 'tasks'; dayCard.appendChild(list);
      const items = await loadDay(ds);
      if (items.length === 0) addTaskRow(list, ds); else items.forEach(t => addTaskRow(list, ds, t.name, t.cat, t.time));
      updateDayTotal();
    }

    function addTaskRow(wrapper, ds, name='', catId='', time=''){
      const row = taskTpl.content.firstElementChild.cloneNode(true);
      const nameEl = row.querySelector('.t-name'); const catEl = row.querySelector('.t-cat'); const timeEl = row.querySelector('.t-time');
      fillCatOptions(catEl, catId);
      nameEl.value = name; timeEl.value = time;
      nameEl.addEventListener('keydown', e => { if (e.key === 'Enter') { e.preventDefault(); timeEl.focus(); } });
      timeEl.addEventListener('keydown', e => { if (e.key === 'Enter') { e.preventDefault(); const nr = addTaskRow(wrapper, ds); nr.querySelector('.t-name').focus(); saveDay(ds); } });
      nameEl.addEventListener('input', () => { saveDay(ds); });
      timeEl.addEventListener('input', () => { saveDay(ds); updateDayTotal(); });
      catEl.addEventListener('change', () => { saveDay(ds); renderLog(); });
      row.querySelector('.t-del').addEventListener('click', () => { row.remove(); saveDay(ds); updateDayTotal(); renderLog(); });
      wrapper.appendChild(row);
      return row;
    }

    function fillCatOptions(selectEl, selectedId){
      selectEl.innerHTML = '';
      const none = document.createElement('option'); none.value = ''; none.textContent = 'Uncategorized'; selectEl.appendChild(none);
      for (const c of categories) { const o=document.createElement('option'); o.value=c.id; o.textContent=c.name; if (c.id===selectedId) o.selected=true; selectEl.appendChild(o); }
    }

    const logWrap = document.getElementById('logWrap');
    const logBody = document.getElementById('logBody');
    const logTotal = document.getElementById('logTotal');
    const filterCat = document.getElementById('filterCat');

    function renderFilter(){
      filterCat.innerHTML='';
      const all = document.createElement('option'); all.value=''; all.textContent='All'; filterCat.appendChild(all);
      for (const c of categories) { const o=document.createElement('option'); o.value=c.id; o.textContent=c.name; filterCat.appendChild(o); }
    }

    async function renderLog(){
      if (USE_SERVER) {
        try {
          const data = await serverGet('/api/log');
          // Merge into local cache for quick client filter
          store = data.days || {};
          localStorage.setItem(KEY, JSON.stringify(store));
        } catch(e) { /* keep local */ }
      }
      const entries = [];
      for (const ds of Object.keys(store)){
        for (const t of store[ds]){ entries.push({ date: ds, name: t.name || '', time: t.time || '', cat: t.cat || '' }); }
      }
      entries.sort((a,b)=> a.date.localeCompare(b.date));
      const catFilter = filterCat.value || '';
      logBody.innerHTML = '';
      let total = 0;
      for (const e of entries){
        if (catFilter && e.cat !== catFilter) continue;
        const tr = document.createElement('tr');
        const cat = categories.find(c => c.id === e.cat);
        const color = cat ? cat.color : '#9aa3b2';
        const catName = cat ? cat.name : 'Uncategorized';
        tr.innerHTML = `<td>${e.date}</td><td><span class="chip"><span class="dot" style="background:${color}"></span>${catName}</span></td><td>${escapeHtml(e.name)}</td><td>${e.time}</td>`;
        logBody.appendChild(tr);
        total += parseTimeToMinutes(e.time);
      }
      logTotal.textContent = minutesToHm(total);
    }

    function escapeHtml(s){ return s.replace(/[&<>\"]/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','\"':'&quot;'}[c])); }

    const catModal = document.getElementById('catModal');
    const catList = document.getElementById('catList');
    const newCatName = document.getElementById('newCatName');
    const newCatColor = document.getElementById('newCatColor');

    function openModal(){ catModal.style.display='flex'; renderCatList(); }
    function closeModal(){ catModal.style.display='none'; }

    function renderCatList(){
      catList.innerHTML = '';
      for (const c of categories){
        const row = document.createElement('div'); row.className='row';
        row.innerHTML = `<input type="text" value="${c.name}" data-id="${c.id}" class="c-name" />`+
                        `<input type="color" value="${c.color}" data-id="${c.id}" class="c-color" />`+
                        `<button class="danger c-del" data-id="${c.id}">Ã—</button>`;
        catList.appendChild(row);
      }
      catList.querySelectorAll('.c-name').forEach(el => el.addEventListener('input', onEditCat));
      catList.querySelectorAll('.c-color').forEach(el => el.addEventListener('input', onEditCat));
      catList.querySelectorAll('.c-del').forEach(el => el.addEventListener('click', onDeleteCat));
    }

    async function onEditCat(e){
      const id = e.target.getAttribute('data-id');
      const idx = categories.findIndex(c => c.id === id);
      if (idx === -1) return;
      if (e.target.classList.contains('c-name')) categories[idx].name = e.target.value;
      if (e.target.classList.contains('c-color')) categories[idx].color = e.target.value;
      localStorage.setItem(CAT_KEY, JSON.stringify(categories));
      if (USE_SERVER) { try { await serverPut('/api/categories', { categories }); } catch(e){} }
      refreshAllCatSelects(); renderFilter(); renderLog();
    }

    async function onDeleteCat(e){
      const id = e.target.getAttribute('data-id');
      categories = categories.filter(c => c.id !== id);
      localStorage.setItem(CAT_KEY, JSON.stringify(categories));
      if (USE_SERVER) { try { await serverPut('/api/categories', { categories }); } catch(e){} }
      renderCatList(); refreshAllCatSelects(); renderFilter(); renderLog();
    }

    document.getElementById('addCat').addEventListener('click', async () => {
      const name = newCatName.value.trim(); const color = newCatColor.value;
      if (!name) return;
      const id = name.toLowerCase().replace(/[^a-z0-9]+/g,'-').replace(/(^-|-$)/g,'');
      if (categories.some(c => c.id === id)) { alert('Category exists'); return; }
      categories.push({ id, name, color });
      localStorage.setItem(CAT_KEY, JSON.stringify(categories));
      if (USE_SERVER) { try { await serverPut('/api/categories', { categories }); } catch(e){} }
      newCatName.value=''; renderCatList(); refreshAllCatSelects(); renderFilter(); renderLog();
    });

    function refreshAllCatSelects(){
      document.querySelectorAll('select.t-cat').forEach(sel => {
        const selected = sel.value;
        fillCatOptions(sel, selected);
      });
    }

    document.getElementById('openCats').addEventListener('click', openModal);
    document.getElementById('closeCats').addEventListener('click', closeModal);
    catModal.addEventListener('click', (e)=>{ if (e.target === catModal) closeModal(); });

    document.getElementById('addTask').addEventListener('click', () => {
      const ds = daySelect.value; const list = dayCard.querySelector('.tasks'); const row = addTaskRow(list, ds); row.querySelector('.t-name').focus(); saveDay(ds);
    });
    daySelect.addEventListener('change', () => renderDay(daySelect.value));
    document.getElementById('toggleLog').addEventListener('click', () => { logWrap.style.display = logWrap.style.display === 'none' ? '' : 'none'; });
    filterCat.addEventListener('change', renderLog);

    async function init() {
      await ensureDefaultCategories();
      if (USE_SERVER) {
        try {
          const r = await serverGet('/api/categories');
          if (Array.isArray(r.categories) && r.categories.length) {
            categories = r.categories;
            localStorage.setItem(CAT_KEY, JSON.stringify(categories));
          } else {
            await serverPut('/api/categories', { categories });
          }
        } catch(e) { /* keep local */ }
      }
      renderFilter();
      await renderDay(todayStr);
      renderLog();
    }

    init();
  </script>
</body>
</html>
